<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Success - ThreadAi</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            background: white;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-width: 500px;
        }

        .success-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
        }

        p {
            color: #666;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .btn {
            background: #007aff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            margin: 10px;
        }

        .btn:hover {
            background: #0056cc;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .status {
            margin: 20px 0;
            padding: 10px;
            border-radius: 6px;
            font-weight: 500;
        }

        .status.checking {
            background: #e3f2fd;
            color: #1976d2;
        }

        .status.success {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .status.error {
            background: #ffebee;
            color: #c62828;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="success-icon">🎉</div>
        <h1>Payment Successful!</h1>
        <p>Thank you for upgrading to ThreadAi Premium!</p>

        <div class="status checking" id="status">
            🔄 Activating your premium features...
        </div>

        <button class="btn" onclick="activateExtension()" id="activateBtn">
            Activate Premium Features
        </button>

        <button class="btn btn-secondary" onclick="openExtension()" id="extensionBtn" style="display: none;">
            Open ThreadAi Extension
        </button>

        <div id="installPrompt"
            style="display: none; margin-top: 20px; padding: 15px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px;">
            <p style="margin: 0; color: #856404;">
                <strong>Extension Not Found!</strong><br>
                Please install the ThreadAi extension first, then return to this page.
            </p>
            <a href="chrome://extensions/" class="btn" style="margin-top: 10px; display: inline-block;">
                Open Extensions Page
            </a>
        </div>

        <p style="font-size: 12px; color: #999; margin-top: 30px;">
            Having issues? <a href="mailto:support@threadai.com">Contact Support</a>
        </p>
    </div>

    <script>
        // Get URL parameters - Lemon Squeezy might pass different parameter names
        const urlParams = new URLSearchParams(window.location.search);

        // Get parameters and handle placeholder strings
        let sessionId = urlParams.get('session_id') ||
            urlParams.get('checkout_custom_session_id') ||
            urlParams.get('custom_session_id');

        let planId = urlParams.get('plan_id') ||
            urlParams.get('checkout_custom_plan_id') ||
            urlParams.get('custom_plan_id');

        let timestamp = urlParams.get('timestamp') ||
            urlParams.get('checkout_custom_timestamp') ||
            urlParams.get('custom_timestamp');

        // Check if we got placeholder strings instead of actual values
        if (!sessionId || sessionId.includes('checkout_custom') || sessionId.includes('{')) {
            console.log('⚠️ Session ID is placeholder, generating new one');
            sessionId = generateFallbackSessionId();
        }

        if (!planId || planId.includes('checkout_custom') || planId.includes('{')) {
            console.log('⚠️ Plan ID is placeholder, using default');
            planId = 'monthly';
        }

        if (!timestamp || timestamp.includes('checkout_custom') || timestamp.includes('{')) {
            console.log('⚠️ Timestamp is placeholder, using current time');
            timestamp = Date.now().toString();
        }

        // Fallback session ID generation
        function generateFallbackSessionId() {
            const now = Date.now();
            const random = Math.random().toString(36).substring(2, 15);
            return btoa(`${now}-${random}-payment`).replace(/[^a-zA-Z0-9]/g, '').substring(0, 16);
        }

        // Log all URL parameters to see what Lemon Squeezy actually sends
        console.log('🎉 Payment success page loaded');
        console.log('📋 All URL parameters:', Object.fromEntries(urlParams));
        console.log('🔑 Extracted values:', { sessionId, planId, timestamp });

        // Also check for common Lemon Squeezy parameters
        const orderId = urlParams.get('order_id') || urlParams.get('checkout_id');
        const email = urlParams.get('email') || urlParams.get('customer_email');
        console.log('💳 Payment info:', { orderId, email });

        async function activateExtension() {
            const statusDiv = document.getElementById('status');
            const activateBtn = document.getElementById('activateBtn');
            const extensionBtn = document.getElementById('extensionBtn');

            try {
                statusDiv.className = 'status checking';
                statusDiv.innerHTML = '🔄 Connecting to ThreadAi extension...';
                activateBtn.disabled = true;

                // Try to communicate with extension
                const extensionId = 'ifnbemppljpgmpfilfkkkonjpeomhcfl'; // Your extension ID

                console.log('🔌 Attempting to connect to extension:', extensionId);

                // Check if Chrome extension APIs are available
                if (typeof chrome === 'undefined' || !chrome.runtime) {
                    throw new Error('Chrome extension APIs not available. Please make sure you are using Chrome browser.');
                }

                try {
                    const response = await chrome.runtime.sendMessage(extensionId, {
                        action: 'PAYMENT_SUCCESS',
                        payload: {
                            sessionId: sessionId,
                            planId: planId || 'monthly',
                            timestamp: timestamp ? parseInt(timestamp) : Date.now(),
                            premium: true,
                            source: 'web_success_page',
                            orderId: orderId,
                            email: email,
                            allParams: Object.fromEntries(urlParams) // Send all parameters for debugging
                        }
                    });

                    console.log('📨 Extension response:', response);

                    if (response && response.success) {
                        statusDiv.className = 'status success';
                        statusDiv.innerHTML = '✅ Premium features activated successfully!';
                        activateBtn.style.display = 'none';
                        extensionBtn.style.display = 'inline-block';
                    } else {
                        throw new Error(response?.error || 'Failed to activate premium');
                    }
                } catch (extensionError) {
                    console.error('Extension communication failed:', extensionError);

                    // Check if extension is installed
                    if (extensionError.message.includes('Could not establish connection')) {
                        throw new Error('ThreadAi extension not found. Please make sure the extension is installed and enabled.');
                    } else {
                        throw extensionError;
                    }
                }
            } catch (error) {
                console.error('Activation error:', error);
                statusDiv.className = 'status error';

                if (error.message.includes('extension not found') || error.message.includes('Could not establish connection')) {
                    statusDiv.innerHTML = '⚠️ ThreadAi extension not found. Please install the extension first.';
                    document.getElementById('installPrompt').style.display = 'block';
                } else {
                    statusDiv.innerHTML = '⚠️ Please open your ThreadAi extension manually to complete activation.';
                    extensionBtn.style.display = 'inline-block';
                }

                activateBtn.textContent = 'Try Again';
                activateBtn.disabled = false;
            }
        }

        function openExtensionDirectly() {
            const extensionId = 'ifnbemppljpgmpfilfkkkonjpeomhcfl';
            const extensionUrl = `chrome-extension://${extensionId}/public/success.html?session_id=${sessionId}&plan_id=${planId}&timestamp=${timestamp}`;

            // Try to open extension success page
            window.location.href = extensionUrl;

            // Fallback message
            setTimeout(() => {
                const statusDiv = document.getElementById('status');
                statusDiv.className = 'status success';
                statusDiv.innerHTML = '✅ Redirecting to extension... If it doesn\'t open automatically, please open ThreadAi extension manually.';
            }, 1000);
        }

        function openExtension() {
            // Try to open extension popup
            const extensionId = 'ifnbemppljpgmpfilfkkkonjpeomhcfl';
            window.open(`chrome-extension://${extensionId}/public/popup/popup.html`, '_blank');
        }

        // Auto-activate if we have session data
        window.addEventListener('load', () => {
            if (sessionId) {
                console.log('🚀 Auto-activating premium with session:', sessionId);
                setTimeout(activateExtension, 1500);
            } else {
                document.getElementById('status').innerHTML = '⚠️ No session data found. Please try the activation manually.';
            }
        });
    </script>
</body>

</html>
